2. 握手阶段：3 次交互建立会话密钥
握手的目标是协商临时会话密钥（避免长期使用同一密钥的安全风险），流程如下（以 A 主动连接 B 为例）：


┌─────────────┐                  ┌─────────────┐
│    节点 A   │                  │    节点 B    │
│ （发起方）   │                  │ （响应方）    │
└───────┬─────┘                  └───────┬─────┘
        │                                │
        │  1. 发起包（ Initiation ）       │
        │  ┌─────────────────────────┐   │
        │  │ - 随机数（A 的临时公钥）   │    │
        │  │ - 用 B 的公钥加密         │    │
        ├─▶│ - 时间戳（防重放）         │────┘
        │  └─────────────────────────┘
        │                                │
        │  2. 响应包（ Response ）         │
        │  ┌─────────────────────────┐    │
        │  │ - 随机数（B 的临时公钥）   │    │
        │  │ - 用 A 的公钥加密         │    │
        │  │ - 时间戳（防重放）         │    │
        │  └─────────────────────────┘◀───┘
        │                                 │
        │  3. 确认包（ Empty Ack ）         │
        │  ┌─────────────────────────┐    │
        │  │ - 空包（仅确认接收）        │   │
        ├─▶│ - 用会话密钥加密           │────┘
        │  └─────────────────────────┘
        │                                │
        │  握手完成，双方生成相同会话密钥     │
        │  （基于各自私钥+对端临时公钥）      │
        ▼                                ▼

核心细节：
临时公钥：每次握手生成随机临时密钥对，用于计算会话密钥（前向保密：即使长期私钥泄露，过去的会话也无法解密）。
加密握手：发起包和响应包均用对端的长期公钥加密，确保只有目标节点能解密（防止中间人窃听）。
会话密钥：双方通过各自的私钥 + 对端的临时公钥，计算出相同的会话密钥（使用 ECDH 密钥交换算法），用于后续数据加密。


3. 数据传输阶段：加密 IP 包
握手完成后，双方进入数据传输阶段，流程如下：

┌─────────────┐                  ┌─────────────┐
│    节点 A    │                  │    节点 B    │
└───────┬─────┘                  └───────┬─────┘
        │                                │
        │  本地 IP 包（如 192.168.1.1 → 10.0.0.2）
        │  ┌─────────────────────┐
        │  │ 原始 IP 包           │
        │  └─────────┬───────────┘
        │            │
        │  用会话密钥加密 + 封装
        │  ┌─────────────────────┐
        │  │ WireGuard 头部       │ （包含序号、密钥索引）
        │  │ 加密的 IP 包         │ （ChaCha20-Poly1305 加密+认证）
        │  └─────────┬───────────┘
        │            │
        │  封装为 UDP 包发送
        ├─▶┌─────────────────────┐───────▶
        │  │ UDP 头部（端口 51820）│.      |
        │  │ WireGuard 加密包     │.      |
        │  └─────────────────────┘.      |
        │                                │
        │                           解密 + 验证
        │  ┌─────────────────────┐.       |
        │  │ 原始 IP 包          │◀────────┘
        │  └─────────┬───────────┘
        │            │
        │  转发到本地网络（如 10.0.0.2）
        ▼                                ▼