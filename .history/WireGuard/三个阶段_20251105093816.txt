2. 握手阶段：3 次交互建立会话密钥
握手的目标是协商临时会话密钥（避免长期使用同一密钥的安全风险），流程如下（以 A 主动连接 B 为例）：


┌─────────────┐                  ┌─────────────┐
│    节点 A   │                  │    节点 B    │
│ （发起方）   │                  │ （响应方）    │
└───────┬─────┘                  └───────┬─────┘
        │                                │
        │  1. 发起包（ Initiation ）       │
        │  ┌─────────────────────────┐   │
        │  │ - 随机数（A 的临时公钥）   │    │
        │  │ - 用 B 的公钥加密         │    │
        ├─▶│ - 时间戳（防重放）         │────┘
        │  └─────────────────────────┘
        │                                │
        │  2. 响应包（ Response ）         │
        │  ┌─────────────────────────┐    │
        │  │ - 随机数（B 的临时公钥）   │    │
        │  │ - 用 A 的公钥加密         │    │
        │  │ - 时间戳（防重放）         │    │
        │  └─────────────────────────┘◀───┘
        │                                 │
        │  3. 确认包（ Empty Ack ）         │
        │  ┌─────────────────────────┐    │
        │  │ - 空包（仅确认接收）        │   │
        ├─▶│ - 用会话密钥加密           │────┘
        │  └─────────────────────────┘
        │                                │
        │  握手完成，双方生成相同会话密钥     │
        │  （基于各自私钥+对端临时公钥）      │
        ▼                                ▼

核心细节：
临时公钥：每次握手生成随机临时密钥对，用于计算会话密钥（前向保密：即使长期私钥泄露，过去的会话也无法解密）。
加密握手：发起包和响应包均用对端的长期公钥加密，确保只有目标节点能解密（防止中间人窃听）。
会话密钥：双方通过各自的私钥 + 对端的临时公钥，计算出相同的会话密钥（使用 ECDH 密钥交换算法），用于后续数据加密。


3. 数据传输阶段：加密 IP 包
握手完成后，双方进入数据传输阶段，流程如下：

┌─────────────┐                  ┌─────────────┐
│    节点 A    │                  │    节点 B    │
└───────┬─────┘                  └───────┬─────┘
        │                                │
        │  本地 IP 包（如 192.168.1.1 → 10.0.0.2）
        │  ┌─────────────────────┐
        │  │ 原始 IP 包           │
        │  └─────────┬───────────┘
        │            │
        │  用会话密钥加密 + 封装
        │  ┌─────────────────────┐
        │  │ WireGuard 头部       │ （包含序号、密钥索引）
        │  │ 加密的 IP 包         │ （ChaCha20-Poly1305 加密+认证）
        │  └─────────┬───────────┘
        │            │
        │  封装为 UDP 包发送
        ├─▶┌─────────────────────┐───────▶
        │  │ UDP 头部（端口 51820）│.      |
        │  │ WireGuard 加密包     │.      |
        │  └─────────────────────┘.      |
        │                                │
        │                           解密 + 验证
        │  ┌─────────────────────┐.       |
        │  │ 原始 IP 包          │◀────────┘
        │  └─────────┬───────────┘
        │            │
        │  转发到本地网络（如 10.0.0.2）
        ▼                                ▼

核心细节：
加密算法：使用 ChaCha20-Poly1305 对 IP 包进行加密和认证（同时保证机密性和完整性，防篡改）。
序号机制：每个数据包带递增序号，防止重放攻击（对端会检查序号，拒绝重复或过时的包）。
密钥轮换：会话密钥默认每 120 秒自动重新协商（通过新的握手流程），进一步提升安全性。


三者关系与数据流转图（文字可视化）

┌───────────────┐     ┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│   本地应用/系统 │     │tun模块(vpn规则)|     │   device 模块  │     │     conn 模块  │     远程VPN服务器
│  （产生原始流量 │────>│  接收原始IP包   │────>│  加密/协议处理  │────>│  通过UDP发送   │────>
└───────────────┘     └───────────────┘     └───────────────┘     └───────────────┘

                                                                 ┌───────────────┐
                                                                 │               │      ┌───────────────┐
远程 VPN 服务器────────>│  conn 模块   │────>│  device 模│────────> │     tun 模块  │────> │   本地应用/系统 │
                                                                 └───────────────┘      └───────────────┘    
                        接收加密数据包           解密/校验             转发解密后IP包         （处理“本地流量”）


请求流程如下：
APP -> (OS，根据系统路由规则检测出口ip是否为wg段) -> [wg tun,接收OS发来的包] -> [wg device，判断去向ip是否allow，加密] -> [wg conn，发送给对应ip的peer] -> 网卡