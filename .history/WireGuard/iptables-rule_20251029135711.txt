# 清空现有规则（避免冲突）
sudo iptables -F
sudo iptables -t nat -F

# 1. 允许外网（enp0s5）到内网（enp0s6）的流量转发（A 10.211.55.25 → C 10.37.129.24）
sudo iptables -A FORWARD -i enp0s5 -o enp0s6 -s 10.211.55.25 -d 10.37.129.24 -j ACCEPT

# 2. 允许内网（enp0s6）到外网（enp0s5）的“相关/已建立”连接（C 10.37.129.24 → A 10.211.55.25 的响应）
sudo iptables -A FORWARD -i enp0s6 -o enp0s5 -s 10.37.129.24 -d 10.211.55.25 -m state --state RELATED,ESTABLISHED -j ACCEPT

# 3. DNAT：将 节点A 10.211.55.25 发送到 节点B 外网IP 10.211.55.26 的流量，转发到 节点C 10.37.129.25
# （即 节点A 10.211.55.25 访问 节点B 10.211.55.26 时，实际被转发到C）
sudo iptables -t nat -A PREROUTING -i enp0s5 -s 10.211.55.25 -d 10.211.55.26 -j DNAT --to-destination 10.37.129.24
sudo iptables -t nat -A POSTROUTING -o enp0s5 -s 10.37.129.24 -d 10.211.55.25 -j SNAT --to-source 10.211.55.26

sudo iptables -A FORWARD -i enp0s5 -o enp0s6 -p udp --dport 51820 -j ACCEPT
sudo iptables -A FORWARD -i enp0s6 -o enp0s5 -p udp --sport 51820 -m state --state RELATED,ESTABLISHED -j ACCEPT
sudo iptables -t nat -A PREROUTING -i enp0s5 -p udp --dport 51820 -j DNAT --to-destination 10.37.129.24:51820