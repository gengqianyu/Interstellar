# 客户端向服务器注册流程

客户端(Peer)启动后，需完成注册并从管理服务获取网络配置(如虚拟IP、WireGuard 密钥、访问规则等)核心是“身份验证→设备注册→配置同步"的闭环。

## 核心流程步骤

1. 客户端初始化
**客户端** 启动时(cmd/netbird/main.go)，  
先加载 本地配置(如上次保存的管理服务地址、设备 ID)，  
若为 首次启动 则生成临时 设备ID 和 WireGuard 密钥对(私钥本地保存，公钥用于后续交换)。

2. 连接管理服务
**客户端** 通过 gRPC 连接 **管理服务** (默认地址 <https://api.netbird.io:443>，自托管场景可自定义)，  
发送“注册请求"，包含>:  

    - 设备基本信息(操作系统、主机名、硬件型号);
    - 本地网络接口信息(内网 IP 列表);
    - 临时设备 ID(首次注册)或 已保存的设备ID(重新上线)

3. 身份认证(前置条件)
**管理服务** 收到注册请求后，先校验 **客户端** 身份(依赖 OIDC或API密钥，见第二部分)。  
若未认证，返回“需认证”指令，**客户端** 引导用户完成认证(如打开浏览器跳转到 OIDC 登录页)。

4.设备注册与信息存储
认证通过后，管理服务执行注册逻辑(internal/management/device/register.go):

    - 若为新设备:生成唯一设备 ID，  
    分配虚拟IP(由 pkg/ipam 模块从网络地址池分配)，  
    关联到用户/团队;

    - 若为已有设备:更新设备状态(在线)、刷新最后活跃时间。  
    最终，设备信息(ID、虚拟IP、公钥、所属网经等) 存储到 PostgreSQL 数据库(internal/management/datastore).

5. 配置下发与本地应用  
**管理服务** 向 **客户端** 返回完整配置，包括：

    - 网络基础配置（虚拟 IP、DNS 服务器、MTU 等）；
    - 其他在线设备的信息（设备 ID、虚拟 IP、公钥、公网地址等）；
    - 访问控制规则（哪些设备可互通）。

**客户端** 接收后，通过 internal/client/config_manager.go 保存配置，  
并调用 internal/network/wireguard.go 初始化 WireGuard 接口（创建虚拟网卡、配置私钥和 peer 公钥），完成注册。
