# OIDC 认证流程：internal/management/auth/ 模块的集成逻辑

NetBird 支持 OIDC（OpenID Connect）作为主要认证方式（如支持 Google、GitHub、企业自建 IdP），核心是通过 OIDC 协议完成 “用户身份验证→令牌发放→权限校验”，代码集中在 internal/management/auth/。

## OIDC 核心角色

依赖方（RP）：NetBird 管理服务，负责引导用户认证、验证令牌；  
身份提供商（IdP）：如 Google、Okta，负责用户身份验证并发放令牌；  
用户：通过 IdP 登录，授权 NetBird 访问用户信息。

## 集成流程（代码层面）

1. OIDC 配置初始化
**管理服务** 启动时（cmd/management/main.go），通过 internal/management/auth/oidc.go 初始化 OIDC 客户端，  
加载配置：  

    - IdP 地址（如 <https://accounts.google.com>）；
    - 管理服务器作为 OIDC 客户端，注册时需提供 客户端 ID / 密钥（在 IdP 注册的 NetBird 应用凭证）；
    - 回调地址（如 <https://your-netbird-server/auth/callback>，用于接收 IdP 返回的令牌）。

2. 用户触发认证
**客户端** 首次注册时，**管理服务** 返回 “未认证”，  
**客户端** 打开浏览器 跳转到 **管理服务的认证入口**（/auth/oidc），  
**管理服务** 生成 OIDC 授权 URL（包含 client_id、redirect_uri、scope 等参数），并 redirect 到 IdP 登录页。

3. IdP 验证与令牌返回
用户 在 IdP 完成登录 并授权后，
IdP 将用户 重定向到 NetBird 的回调 地址（/auth/callback），并携带 **授权码**（code）。

4. 管理服务 验证令牌
**管理服务** 通过 oidc_callback_handler（internal/management/auth/server.go）处理回调：  
用 **授权码** 向 IdP 换取 ID 令牌（JWT 格式）和 访问令牌；  
验证 ID 令牌签名（确保来自可信 IdP）、有效期、issuer 等；  
解析 ID 令牌中的用户信息（如 email、sub，作为用户唯一标识）。

5. 生成本地令牌
验证通过后，**管理服务** 生成两个令牌（internal/management/auth/token.go）：  
访问令牌：短期有效（默认 1 小时），用于 **客户端** 后续调用 **管理服务** API；  
刷新令牌：长期有效（默认 30 天），用于过期后获取新访问令牌。  
令牌通过 JWT 签名，密钥 由管理服务 保管（自托管时需配置 JWT_SIGNING_KEY）。

6. 权限校验
**客户端** 后续请求（如注册、获取配置）需在 gRPC 元数据中携带访问令牌，  
**管理服务** 通过 auth_middleware（internal/management/middleware/auth.go）验证令牌有效性，并根据用户 所属 团队 / 角色（存储在数据库）判断权限。
