# P2P 连接建立：STUN 地址发现 与 WireGuard 密钥交换

NetBird 基于 WireGuard 实现加密通信，  
核心是让 两台设备（Peer）通过 “地址发现→密钥交换→直连 / 中继” 建立连接，STUN 用于 解决 内网设备 地址暴露问题，  
**管理服务** 作为 “中介” 传递必要信息（不参与数据传输）。

## 核心流程步骤

1. 本地网络信息收集
**客户端** 启动后（internal/network/addresses.go），收集 自身网络接口 信息：  
内网 IP 列表（如 192.168.x.x、10.x.x.x）；
网络类型（是否在 NAT 后、防火墙规则等）。

2. STUN 公网地址发现
**客户端** 通过内置 STUN 客户端（internal/stun/client.go）向 STUN 服务器（默认 stun.netbird.io:3478）发送请求，  
获取：
    - 公网 IP 和 端口（NAT 映射后的地址，如 203.0.113.5:51820）；
    - NAT 类型（如锥形 NAT、对称 NAT，影响 P2P 直连成功率）。
原理：STUN 服务器 收到请求后，将 经过NAT后的源 IP / 端口（即客户端的公网地址）作为一个响应包 返回给客户端，帮助 客户端 知道 “对外暴露的地址”。

3. 地址信息 上报 管理服务
**客户端** 将 “内网 IP + 端口”“公网 IP + 端口” “NAT 类型” 通过 gRPC 上报 **管理服务**，  
**管理服务** 更新数据库中 该设备的 地址列表（internal/management/device/addresses.go）。

4. 获取 Peer 信息与密钥交换
当 **客户端** 需要 与其他设备通信 时（如用户访问目标设备的虚拟 IP），  
通过 **管理服务** 的 ListPeers API 获取 **目标设备**的信息：
    - 目标设备 的 公网 / 内网地址列表；
    - 目标设备 的 WireGuard 公钥（用于加密通信）。
注意：**管理服务** 仅传递公钥，私钥 始终存储在 **客户端** 本地，确保安全。

5. P2P 直连尝试
客户端通过 internal/network/connmanager.go 尝试与目标设备建立 WireGuard 连接：
按优先级（内网地址→公网地址）向目标设备的地址发送 WireGuard 握手包（UDP 协议）；
若握手成功（收到目标设备的响应），则建立 P2P 连接，后续数据直接通过该连接传输（WireGuard 加密）。

6. TURN 中继兜底
若所有地址均无法直连（如对称 NAT 环境），客户端向管理服务请求 TURN 服务器地址，通过 TURN 中继传输数据：
客户端 A 与 TURN 服务器建立连接，客户端 B 也与同一 TURN 服务器建立连接；
数据通过 TURN 服务器转发（A→TURN→B），确保通信不中断（速度略慢于直连）。
